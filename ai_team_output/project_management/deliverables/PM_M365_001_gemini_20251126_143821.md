# PM_M365_001 - SharePoint & Teams Integration
## Worker: Gemini 2.5 Pro
## Timestamp: 20251126_143821

---

Okay, I'm ready to implement the SharePoint & Teams integration for the SGA QA System's project management module.  I will provide the code for the 6 required files, including the TypeScript modules and the Power Automate flow definitions.

**Important Considerations:**

*   **Environment Variables:**  The code relies heavily on environment variables (e.g., `SHAREPOINT_SITE_ID`, `TEAMS_PROJECT_UPDATES_CHANNEL_ID`).  You'll need to configure these variables in your environment for the code to work correctly.  I will assume these are available.
*   **Authentication:** The code assumes that the `api/_lib/sharepoint.ts` file provides a function to get an authenticated Microsoft Graph client. I will create a placeholder for this.
*   **Error Handling:** I've implemented basic error handling with logging and retries.  You may need to refine this based on your specific requirements.
*   **Adaptive Cards:** The Adaptive Card JSON structures are simplified for brevity. You can customize them further using the Adaptive Cards Designer.
*   **Power Automate:** The Power Automate flows are provided as JSON.  You'll need to import them into Power Automate and configure the connections.
*   **Webhook Endpoints:** You'll need to create the `/api/webhooks/scope-report-submitted` and `/api/webhooks/division-request-response` API routes to handle the webhooks from Power Automate.  I won't implement these routes here, but I'll mention where they are needed.
*   **MSAL Integration:** I'm assuming you have an existing MSAL (Microsoft Authentication Library) integration in your application. The code uses placeholders for getting the access token.

Here are the files:

```typescript
// File: api/_lib/sharepoint-project.ts
import { Client } from '@microsoft/microsoft-graph-client';
import * as MicrosoftGraph from '@microsoft/microsoft-graph-types';

const CONFIG = {
  SHAREPOINT_SITE_ID: process.env.SHAREPOINT_SITE_ID,
  SHAREPOINT_SITE_URL: 'https://sgagroupcomau.sharepoint.com/sites/SGAQualityAssurance',
  PROJECTS_LIBRARY: 'Shared Documents', // Modified to just "Shared Documents"
  TEAMS_PROJECT_UPDATES_CHANNEL: process.env.TEAMS_PROJECT_UPDATES_CHANNEL_ID,
  TEAMS_DIVISION_CHANNEL: process.env.TEAMS_DIVISION_CHANNEL_ID,
  SHARED_CALENDAR_ID: process.env.TEAMS_SHARED_CALENDAR_ID
};

// Placeholder for getting the authenticated Graph client (replace with your actual implementation)
async function getAuthenticatedClient(): Promise<Client> {
  // Replace with your MSAL authentication logic
  // Example:
  // const accessToken = await getAccessTokenFromMSAL();
  // const client = Client.init({
  //   authProvider: (done) => {
  //     done(null, accessToken);
  //   }
  // });
  // return client;
  console.warn("getAuthenticatedClient() is a placeholder.  Implement your MSAL authentication.");
  return {} as Client; //Returning empty object to avoid TS errors.
}

async function retryOperation<T>(operation: () => Promise<T>, maxRetries = 3, delay = 1000): Promise<T> {
  let retryCount = 0;
  while (true) {
    try {
      return await operation();
    } catch (error: any) {
      console.error(`Operation failed (attempt ${retryCount + 1}):`, error);
      if (retryCount >= maxRetries) {
        throw error;
      }
      retryCount++;
      await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, retryCount))); // Exponential backoff
    }
  }
}

/**
 * Create complete folder structure for a new project
 */
export async function createProjectFolders(
  projectNumber: string,
  projectName: string,
  client: string
): Promise<boolean> {
  const clientGraph = await getAuthenticatedClient();
  const rootFolder = `02_Projects/${projectNumber}`;
  const subfolders = ['ScopeReports', 'JobSheets', 'ShiftPlans', 'QAPacks', 'NCRs', 'Incidents', 'Photos'];

  try {
    // Create the root project folder
    await retryOperation(async () => {
      await clientGraph.api(`/sites/${CONFIG.SHAREPOINT_SITE_ID}/drive/root:/${rootFolder}:/children`)
        .post({
          name: rootFolder,
          folder: {},
          '@microsoft.graph.conflictBehavior': 'rename' // or 'fail' or 'replace'
        });
    });

    // Create subfolders
    for (const subfolder of subfolders) {
      await retryOperation(async () => {
        await clientGraph.api(`/sites/${CONFIG.SHAREPOINT_SITE_ID}/drive/root:/${rootFolder}:/children`)
          .post({
            name: subfolder,
            folder: {},
            '@microsoft.graph.conflictBehavior': 'rename'
          });
      });
    }

    return true;
  } catch (error) {
    console.error('Error creating project folders:', error);
    return false;
  }
}

/**
 * Upload document to correct project subfolder
 */
export async function uploadProjectDocument(
  projectNumber: string,
  subfolder: 'ScopeReports' | 'JobSheets' | 'QAPacks' | 'NCRs' | 'Incidents' | 'Photos',
  fileName: string,
  fileContent: Buffer | string
): Promise<string> {
  const clientGraph = await getAuthenticatedClient();
  const filePath = `02_Projects/${projectNumber}/${subfolder}/${fileName}`;

  try {
    const uploadResult = await retryOperation(async () => {
      return await clientGraph.api(`/sites/${CONFIG.SHAREPOINT_SITE_ID}/drive/root:/${filePath}:/content`)
        .put(fileContent);
    });

    const fileUrl = `${CONFIG.SHAREPOINT_SITE_URL}/${CONFIG.PROJECTS_LIBRARY}/02_Projects/${projectNumber}/${subfolder}/${fileName}`; // Construct the URL

    return fileUrl;
  } catch (error) {
    console.error('Error uploading document:', error);
    throw error;
  }
}

/**
 * Set metadata on project folder
 */
export async function setProjectMetadata(
  projectNumber: string,
  metadata: {
    ProjectNumber: string;
    ProjectName: string;
    Client: string;
    ClientTier: string;
    ProjectOwner: string;
    Status: string;
  }
): Promise<boolean> {
  const clientGraph = await getAuthenticatedClient();
  const folderPath = `02_Projects/${projectNumber}`;

  try {
    // Get the folder ID
    const folder = await retryOperation(async () => {
      return await clientGraph.api(`/sites/${CONFIG.SHAREPOINT_SITE_ID}/drive/root:/${folderPath}`)
        .get();
    });

    if (!folder.id) {
      console.error('Folder not found.');
      return false;
    }

    // Update the folder metadata (using ListItem)
    await retryOperation(async () => {
      await clientGraph.api(`/sites/${CONFIG.SHAREPOINT_SITE_ID}/lists/${CONFIG.PROJECTS_LIBRARY}/items/${folder.id}/fields`)
        .patch(metadata);
    });

    return true;
  } catch (error) {
    console.error('Error setting project metadata:', error);
    return false;
  }
}

/**
 * Get all files in a project subfolder
 */
export async function getProjectFiles(
  projectNumber: string,
  subfolder: string
): Promise<Array<{ name: string; url: string; modifiedAt: string }>> {
  const clientGraph = await getAuthenticatedClient();
  const folderPath = `02_Projects/${projectNumber}/${subfolder}`;

  try {
    const files = await retryOperation(async () => {
      const response = await clientGraph.api(`/sites/${CONFIG.SHAREPOINT_SITE_ID}/drive/root:/${folderPath}:/children`)
        .get();
      return response.value;
    });

    if (!files) {
      return [];
    }

    return files.map((file: any) => ({
      name: file.name,
      url: `${CONFIG.SHAREPOINT_SITE_URL}/${CONFIG.PROJECTS_LIBRARY}/${folderPath}/${file.name}`,
      modifiedAt: file.lastModifiedDateTime
    }));
  } catch (error) {
    console.error('Error getting project files:', error);
    return [];
  }
}
```

```typescript
// File: api/_lib/teams-project.ts
import { Client } from '@microsoft/microsoft-graph-client';
import * as MicrosoftGraph from '@microsoft/microsoft-graph-types';

const CONFIG = {
  SHAREPOINT_SITE_ID: process.env.SHAREPOINT_SITE_ID,
  SHAREPOINT_SITE_URL: 'https://sgagroupcomau.sharepoint.com/sites/SGAQualityAssurance',
  PROJECTS_LIBRARY: 'Shared Documents',
  TEAMS_PROJECT_UPDATES_CHANNEL: process.env.TEAMS_PROJECT_UPDATES_CHANNEL_ID,
  TEAMS_DIVISION_CHANNEL: process.env.TEAMS_DIVISION_CHANNEL_ID,
  SHARED_CALENDAR_ID: process.env.TEAMS_SHARED_CALENDAR_ID
};

// Placeholder for getting the authenticated Graph client (replace with your actual implementation)
async function getAuthenticatedClient(): Promise<Client> {
  // Replace with your MSAL authentication logic
  console.warn("getAuthenticatedClient() is a placeholder.  Implement your MSAL authentication.");
  return {} as Client; //Returning empty object to avoid TS errors.
}

async function retryOperation<T>(operation: () => Promise<T>, maxRetries = 3, delay = 1000): Promise<T> {
  let retryCount = 0;
  while (true) {
    try {
      return await operation();
    } catch (error: any) {
      console.error(`Operation failed (attempt ${retryCount + 1}):`, error);
      if (retryCount >= maxRetries) {
        throw error;
      }
      retryCount++;
      await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, retryCount))); // Exponential backoff
    }
  }
}

/**
 * Create calendar event for site visit
 */
export async function createSiteVisitEvent(
  projectName: string,
  visitType: '14-Day' | '7-Day' | '3-Day' | '72-Hour',
  scheduledDate: string,
  location: string,
  scopingPersonEmail: string,
  projectOwnerEmail: string
): Promise<string> {
  const clientGraph = await getAuthenticatedClient();

  try {
    const event = {
      subject: `${visitType} Site Visit - ${projectName}`,
      body: {
        contentType: 'HTML',
        content: `Site visit for project: ${projectName}<br>Location: ${location}`
      },
      start: {
        dateTime: scheduledDate,
        timeZone: 'Australia/Sydney' // Adjust timezone as needed
      },
      end: {
        dateTime: scheduledDate, // Assuming it's a one-day event
        timeZone: 'Australia/Sydney'
      },
      location: {
        displayName: location
      },
      attendees: [
        {
          emailAddress: {
            address: scopingPersonEmail
          },
          type: 'required'
        },
        {
          emailAddress: {
            address: projectOwnerEmail
          },
          type: 'optional'
        }
      ],
      isOnlineMeeting: false
    };

    const createdEvent = await retryOperation(async () => {
      return await clientGraph.api(`/me/calendars/${CONFIG.SHARED_CALENDAR_ID}/events`)
        .post(event);
    });

    return createdEvent.id;
  } catch (error) {
    console.error('Error creating site visit event:', error);
    throw error;
  }
}

/**
 * Create calendar event for job scheduling
 */
export async function createJobEvent(
  jobNo: string,
  projectName: string,
  division: 'Asphalt' | 'Profiling' | 'Spray',
  jobDate: string,
  foremanEmail: string,
  crewEmails: string[]
): Promise<string> {
  const clientGraph = await getAuthenticatedClient();

  try {
    const event = {
      subject: `Job: ${jobNo} - ${projectName} (${division})`,
      body: {
        contentType: 'HTML',
        content: `Job scheduling for project: ${projectName}<br>Division: ${division}`
      },
      start: {
        dateTime: jobDate,
        timeZone: 'Australia/Sydney' // Adjust timezone as needed
      },
      end: {
        dateTime: jobDate, // Assuming it's a one-day event
        timeZone: 'Australia/Sydney'
      },
      attendees: [
        {
          emailAddress: {
            address: foremanEmail
          },
          type: 'required'
        },
        ...crewEmails.map(email => ({
          emailAddress: {
            address: email
          },
          type: 'required'
        }))
      ],
      isOnlineMeeting: false
    };

    const createdEvent = await retryOperation(async () => {
      return await clientGraph.api(`/me/calendars/${CONFIG.SHARED_CALENDAR_ID}/events`)
        .post(event);
    });

    return createdEvent.id;
  } catch (error) {
    console.error('Error creating job event:', error);
    throw error;
  }
}

/**
 * Post adaptive card to Teams channel
 */
export async function postToChannel(
  channelId: string,
  card: any //AdaptiveCard
): Promise<boolean> {
  const clientGraph = await getAuthenticatedClient();

  try {
    const message = {
      body: {
        contentType: 'html',
        content: '<div></div>' // Required for adaptive cards
      },
      attachments: [
        {
          contentType: 'application/vnd.microsoft.card.adaptive',
          contentUrl: null,
          content: card
        }
      ]
    };

    await retryOperation(async () => {
      await clientGraph.api(`/teams/${channelId}/channels/${channelId}/messages`)
        .post(message);
    });

    return true;
  } catch (error) {
    console.error('Error posting to channel:', error);
    return false;
  }
}

/**
 * Create adaptive card for scope report submission
 */
export function createScopeReportCard(
  reportNumber: string,
  projectName: string,
  visitType: string,
  completedBy: string,
  findings: string,
  pdfUrl: string
): any { //AdaptiveCard
  return {
    type: 'AdaptiveCard',
    $schema: 'http://adaptivecards.io/schemas/adaptive-card.json',
    version: '1.4',
    body: [
      {
        type: 'TextBlock',
        text: `Scope Report Submitted: ${reportNumber}`,
        size: 'Medium',
        weight: 'Bolder'
      },
      {
        type: 'TextBlock',
        text: `Project: ${projectName}`
      },
      {
        type: 'TextBlock',
        text: `Visit Type: ${visitType}`
      },
      {
        type: 'TextBlock',
        text: `Completed By: ${completedBy}`
      },
      {
        type: 'TextBlock',
        text: `Key Findings: ${findings}`
      }
    ],
    actions: [
      {
        type: 'Action.OpenUrl',
        title: 'View PDF Report',
        url: pdfUrl
      }
    ]
  };
}

/**
 * Create adaptive card for division request
 */
export function createDivisionRequestCard(
  requestNumber: string,
  fromEngineer: string,
  toEngineer: string,
  projectName: string,
  workDescription: string,
  requestedDates: string[],
  actionUrl: string
): any { //AdaptiveCard
  return {
    type: 'AdaptiveCard',
    $schema: 'http://adaptivecards.io/schemas/adaptive-card.json',
    version: '1.4',
    body: [
      {
        type: 'TextBlock',
        text: `Division Request: ${requestNumber}`,
        size: 'Medium',
        weight: 'Bolder'
      },
      {
        type: 'TextBlock',
        text: `Project: ${projectName}`
      },
      {
        type: 'TextBlock',
        text: `From: ${fromEngineer}`
      },
      {
        type: 'TextBlock',
        text: `To: ${toEngineer}`
      },
      {
        type: 'TextBlock',
        text: `Work Description: ${workDescription}`
      },
      {
        type: 'TextBlock',
        text: `Requested Dates: ${requestedDates.join(', ')}`
      }
    ],
    actions: [
      {
        type: 'Action.OpenUrl',
        title: 'Accept Request',
        url: `${actionUrl}?action=accept&request=${requestNumber}` // Example URL
      },
      {
        type: 'Action.OpenUrl',
        title: 'Reject Request',
        url: `${actionUrl}?action=reject&request=${requestNumber}` // Example URL
      },
      {
        type: 'Action.OpenUrl',
        title: 'View Project',
        url: 'https://example.com/project/123' // Replace with your project URL
      }
    ]
  };
}

/**
 * Send Teams notification with @mention
 */
export async function sendMentionNotification(
  userEmail: string,
  message: string,
  actionUrl?: string
): Promise<boolean> {
  const clientGraph = await getAuthenticatedClient();

  try {
    // Get user ID from email
    const user = await retryOperation(async () => {
      const response = await clientGraph.api(`/users?$filter=mail eq '${userEmail}'`)
        .get();
      return response.value[0];
    });

    if (!user) {
      console.error('User not found:', userEmail);
      return false;
    }

    const userId = user.id;

    const mention = `<at id="${0}">${user.displayName}</at>`;
    const content = `${mention} ${message}`;

    const notificationMessage = {
      body: {
        contentType: 'html',
        content: content
      }
    };

    await retryOperation(async () => {
      await clientGraph.api(`/teams/${CONFIG.TEAMS_PROJECT_UPDATES_CHANNEL}/channels/${CONFIG.TEAMS_PROJECT_UPDATES_CHANNEL}/messages`)
        .post(notificationMessage);
    });

    return true;
  } catch (error) {
    console.error('Error sending mention notification:', error);
    return false;
  }
}
```

```json
// File: m365-deployment/power-automate/ProjectFolderCreation.json
{
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "$connections": {
        "defaultValue": {},
        "type": "Object"
      }
    },
    "triggers": {
      "manual": {
        "type": "Request",
        "kind": "Http",
        "inputs": {
          "schema": {
            "type": "object",
            "properties": {
              "projectNumber": {
                "type": "string"
              },
              "projectName": {
                "type": "string"
              },
              "client": {
                "type": "string"
              },
              "clientTier": {
                "type": "string"
              },
              "projectOwner": {
                "type": "string"
              }
            },
            "required": [
              "projectNumber",
              "projectName",
              "client",
              "clientTier",
              "projectOwner"
            ]
          }
        }
      }
    },
    "actions": {
      "Parse_JSON": {
        "runAfter": {},
        "type": "ParseJson",
        "inputs": {
          "content": "@triggerBody()",
          "schema": {
            "type": "object",
            "properties": {
              "projectNumber": {
                "type": "string"
              },
              "projectName": {
                "type": "string"
              },
              "client": {
                "type": "string"
              },
              "clientTier": {
                "type": "string"
              },
              "projectOwner": {
                "type": "string"
              }
            },
            "required": [
              "projectNumber",
              "projectName",
              "client",
              "clientTier",
              "projectOwner"
            ]
          }
        }
      },
      "Create_Root_Folder": {
        "runAfter": {
          "Parse_JSON": [
            "Succeeded"
          ]
        },
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['shared_sharepointonline']['connectionId']"
            }
          },
          "method": "post",
          "path": "/datasets/@{encodeURIComponent(triggerBody()?['entity'])}/CreateFolder",
          "queries": {
            "folderPath": "/Shared Documents/02_Projects",
            "name": "@{body('Parse_JSON')?['projectNumber']}"
          }
        }
      },
      "Create_Subfolders": {
        "foreach": "@array('ScopeReports', 'JobSheets', 'ShiftPlans', 'QAPacks', 'NCRs', 'Incidents', 'Photos')",
        "actions": {
          "Create_Subfolder": {
            "runAfter": {},
            "type": "ApiConnection",
            "inputs": {
              "host": {
                "connection": {
                  "name": "@parameters('$connections')['shared_sharepointonline']['connectionId']"
                }
              },
              "method": "post",
              "path": "/datasets/@{encodeURIComponent(triggerBody()?['entity'])}/CreateFolder",
              "queries": {
                "folderPath": "/Shared Documents/02_Projects/@{body('Parse_JSON')?['projectNumber']}",
                "name": "@items('Create_Subfolders')"
              }
            }
          }
        },
        "runAfter": {
          "Create_Root_Folder": [
            "Succeeded"
          ]
        },
        "type": "Foreach"
      },
      "Set_Folder_Metadata": {
        "runAfter": {
          "Create_Subfolders": [
            "Succeeded"
          ]
        },
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['shared_sharepointonline']['connectionId']"
            }
          },
          "method": "patch",
          "path": "/datasets/@{encodeURIComponent(triggerBody()?['entity'])}/items/@{body('Create_Root_Folder')?['Id']}",
          "body": {
            "ProjectNumber": "@{body('Parse_JSON')?['projectNumber']}",
            "ProjectName": "@{body('Parse_JSON')?['projectName']}",
            "Client": "@{body('Parse_JSON')?['client']}",
            "ClientTier": "@{body('Parse_JSON')?['clientTier']}",
            "ProjectOwner": "@{body('Parse_JSON')?['projectOwner']}",
            "Status": "Active"
          }
        }
      },
      "Add_to_Projects_List": {
        "runAfter": {
          "Set_Folder_Metadata": [
            "Succeeded"
          ]
        },
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['shared_sharepointonline']['connectionId']"
            }
          },
          "method": "post",
          "path": "/datasets/@{encodeURIComponent(triggerBody()?['entity'])}/tables/@{encodeURIComponent('Projects')}/items",
          "body": {
            "ProjectNumber": "@{body('Parse_JSON')?['projectNumber']}",
            "ProjectName": "@{body('Parse_JSON')?['projectName']}",
            "Client": "@{body('Parse_JSON')?['client']}",
            "ClientTier": "@{body('Parse_JSON')?['clientTier']}",
            "ProjectOwner": "@{body('Parse_JSON')?['projectOwner']}",
            "Status": "Active",
            "SharePointFolderURL": "@{body('Create_Root_Folder')?['AbsoluteUri']}"
          }
        }
      },
      "Response": {
        "runAfter": {
          "Add_to_Projects_List": [
            "Succeeded"
          ]
        },
        "type": "Response",
        "kind": "Http",
        "inputs": {
          "statusCode": 200,
          "body": {
            "message": "Project folders created successfully."
          }
        }
      }
    }
  },
  "parameters": {
    "$connections": {
      "value": {
        "shared_sharepointonline": {
          "connectionId": "/subscriptions/<your_subscription_id>/resourceGroups/<your_resource_group>/providers/Microsoft.Web/connections/sharepointonline",
          "connectionName": "sharepointonline",
          "id": "/subscriptions/<your_subscription_id>/providers/Microsoft.Web/locations/australiaeast/managedApis/sharepointonline"
        }
      }
    }
  }
}
```

```json
// File: m365-deployment/power-automate/ScopeReportNotification.json
{
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "$connections": {
        "defaultValue": {},
        "type": "Object"
      }
    },
    "triggers": {
      "When_a_file_is_created_or_modified_(properties_only)": {
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['shared_sharepointonline']['connectionId']"
            }
          },
          "method": "get",
          "path": "/datasets/@{encodeURIComponent(triggerBody()?['entity'])}/triggers/batch/onFileCreated",
          "queries": {
            "folderId": "/Shared Documents/02_Projects",
            "includeNestedItems": true
          }
        }
      }
    },
    "actions": {
      "Get_file_metadata": {
        "runAfter": {},
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['shared_sharepointonline']['connectionId']"
            }
          },
          "method": "get",
          "path": "/datasets/@{encodeURIComponent(triggerBody()?['entity'])}/items/@{encodeURIComponent(triggerBody()?['Id'])}",
          "queries": {
            "$select": "Name,Path,CreatedBy,Modified,Editor"
          }
        }
      },
      "Parse_Project_Number": {
        "runAfter": {
          "Get_file_metadata": [
            "Succeeded"
          ]
        },
        "type": "Compose",
        "inputs": "@split(split(outputs('Get_file_metadata')?['body/Path'],'/')[3],'ScopeReports')[0]"
      },
      "Get_Project_Metadata": {
        "runAfter": {
          "Parse_Project_Number": [
            "Succeeded"
          ]
        },
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['shared_sharepointonline']['connectionId']"
            }
          },
          "method": "get",
          "path": "/datasets/@{encodeURIComponent(triggerBody()?['entity'])}/items",
          "queries": {
            "$filter": "ProjectNumber eq '@{outputs('Parse_Project_Number')}'"
          }
        }
      },
      "Post_Adaptive_Card_to_Teams": {
        "runAfter": {
          "Get_Project_Metadata": [
            "Succeeded"
          ]
        },
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['shared_teams']['connectionId']"
            }
          },
          "method": "post",
          "path": "/teams/@{encodeURIComponent('<Your_Team_ID>')}/channels/@{encodeURIComponent('<Your_Channel_ID>')}/messages",
          "body": {
            "body": {
              "contentType": "html",
              "content": "<div></div>"
            },
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "contentUrl": null,
                "content": {
                  "type": "AdaptiveCard",
                  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "version": "1.4",
                  "body": [
                    {
                      "type": "TextBlock",
                      "text": "New Scope Report Submitted",
                      "size": "Medium",
                      "weight": "Bolder"
                    },
                    {
                      "type": "TextBlock",
                      "text": "Project: @{body('Get_Project_Metadata')?['ProjectName']}"
                    },
                    {
                      "type": "TextBlock",
                      "text": "Report Name: @{triggerBody()?['{Name}']}"
                    },
                    {
                      "type": "TextBlock",
                      "text": "Completed By: @{body('Get_file_metadata')?['body/Editor/DisplayName']}"
                    }
                  ],
                  "actions": [
                    {
                      "type": "Action.OpenUrl",
                      "title": "View Report",
                      "url": "@{triggerBody()?['{Link}']}"
                    }
                  ]
                }
              }
            ]
          }
        }
      },
      "Send_Email_to_Project_Owner": {
        "runAfter": {
          "Post_Adaptive_Card_to_Teams": [
            "Succeeded"
          ]
        },
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['shared_office365outlook']['connectionId']"
            }
          },
          "method": "post",
          "path": "/Mail",
          "body": {
            "ToRecipients": [
              {
                "EmailAddress": {
                  "Address": "@{body('Get_Project_Metadata')?['ProjectOwner']}"
                }
              }
            ],
            "Subject": "New Scope Report Submitted for @{body('Get_Project_Metadata')?['ProjectName']}",
            "Body": {
              "ContentType": "HTML",
              "Content": "A new scope report has been submitted for project @{body('Get_Project_Metadata')?['ProjectName']}. Please review the report."
            }
          }
        }
      }
    }
  },
  "parameters": {
    "$connections": {
      "value": {
        "shared_sharepointonline": {
          "connectionId": "/subscriptions/<your_subscription_id>/resourceGroups/<your_resource_group>/providers/Microsoft.Web/connections/sharepointonline",
          "connectionName": "sharepointonline",
          "id": "/subscriptions/<your_subscription_id>/providers/Microsoft.Web/locations/australiaeast/managedApis/sharepointonline"
        },
        "shared_teams": {
          "connectionId": "/subscriptions/<your_subscription_id>/resourceGroups/<your_resource_group>/providers/Microsoft.Web/connections/microsoftteams",
          "connectionName": "microsoftteams",
          "id": "/subscriptions/<your_subscription_id>/providers/Microsoft.Web/locations/australiaeast/managedApis/microsoftteams"
        },
        "shared_office365outlook": {
          "connectionId": "/subscriptions/<your_subscription_id>/resourceGroups/<your_resource_group>/providers/Microsoft.Web/connections/office365",
          "connectionName": "office365",
          "id": "/subscriptions/<your_subscription_id>/providers/Microsoft.Web/locations/australiaeast/managedApis/office365"
        }
      }
    }
  }
}
```

```json
// File: m365-deployment/power-automate/DivisionRequestFlow.json
{
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "$connections": {
        "defaultValue": {},
        "type": "Object"
      }
    },
    "triggers": {
      "When_a_HTTP_request_is_received": {
        "type": "Request",
        "kind": "Http",
        "inputs": {
          "schema": {
            "type": "object",
            "properties": {
              "requestNumber": {
                "type": "string"
              },
              "projectId": {
                "type": "string"
              },
              "projectName": {
                "type": "string"
              },
              "requestedBy": {
                "type": "string"
              },
              "requestedTo": {
                "type": "string"
              },
              "division": {
                "type": "string"
              },
              "workDescription": {
                "type": "string"
              