# Dataverse Schema Definition - Complete Implementation Guide (Part 2)

## Continuing Table Definitions...

#### 7. msdyn_ncr (Non-Conformance Reports)

```json
{
  "SchemaName": "msdyn_ncr",
  "DisplayName": "Non-Conformance Report",
  "PluralDisplayName": "NCR Register",
  "Attributes": [
    {
      "SchemaName": "msdyn_ncrid",
      "Type": "PrimaryKey"
    },
    {
      "SchemaName": "msdyn_ncrnumber",
      "DisplayName": "NCR Number",
      "Type": "String",
      "MaxLength": 50,
      "Required": true,
      "AutoNumber": {
        "Prefix": "NCR-",
        "StartingNumber": 1,
        "Suffix": "-{YEAR}"
      }
    },
    {
      "SchemaName": "msdyn_job",
      "DisplayName": "Related Job",
      "Type": "Lookup",
      "Target": "msdyn_job",
      "Required": true
    },
    {
      "SchemaName": "msdyn_qapack",
      "DisplayName": "Related QA Pack",
      "Type": "Lookup",
      "Target": "msdyn_qapack"
    },
    {
      "SchemaName": "msdyn_dateissued",
      "DisplayName": "Date Issued",
      "Type": "DateTime",
      "Format": "DateOnly",
      "Required": true
    },
    {
      "SchemaName": "msdyn_issuedby",
      "DisplayName": "Issued By",
      "Type": "Lookup",
      "Target": "systemuser",
      "Required": true
    },
    {
      "SchemaName": "msdyn_status",
      "DisplayName": "Status",
      "Type": "OptionSet",
      "Options": [
        {"Value": 1, "Label": "Open", "Color": "#D13438"},
        {"Value": 2, "Label": "Under Review", "Color": "#0078D4"},
        {"Value": 3, "Label": "Resolved", "Color": "#FFB900"},
        {"Value": 4, "Label": "Closed", "Color": "#107C10"},
        {"Value": 5, "Label": "Rejected", "Color": "#8A8A8A"}
      ],
      "DefaultValue": 1
    },
    {
      "SchemaName": "msdyn_description",
      "DisplayName": "Description of Non-Conformance",
      "Type": "Memo",
      "MaxLength": 5000,
      "Required": true
    },
    {
      "SchemaName": "msdyn_specificationclause",
      "DisplayName": "Specification Clause Reference",
      "Type": "String",
      "MaxLength": 200
    },
    {
      "SchemaName": "msdyn_proposedcorrectiveaction",
      "DisplayName": "Proposed Corrective Action",
      "Type": "Memo",
      "MaxLength": 5000
    },
    {
      "SchemaName": "msdyn_rootcauseanalysis",
      "DisplayName": "Root Cause Analysis",
      "Type": "Memo",
      "MaxLength": 10000
    },
    {
      "SchemaName": "msdyn_preventativeaction",
      "DisplayName": "Preventative Action",
      "Type": "Memo",
      "MaxLength": 5000
    },
    {
      "SchemaName": "msdyn_verificationmethod",
      "DisplayName": "Verification Method",
      "Type": "String",
      "MaxLength": 500
    },
    {
      "SchemaName": "msdyn_verifiedby",
      "DisplayName": "Verified By",
      "Type": "Lookup",
      "Target": "systemuser"
    },
    {
      "SchemaName": "msdyn_verificationdate",
      "DisplayName": "Verification Date",
      "Type": "DateTime",
      "Format": "DateOnly"
    },
    {
      "SchemaName": "msdyn_closedby",
      "DisplayName": "Closed By",
      "Type": "Lookup",
      "Target": "systemuser"
    },
    {
      "SchemaName": "msdyn_closedate",
      "DisplayName": "Close Date",
      "Type": "DateTime",
      "Format": "DateAndTime"
    },
    {
      "SchemaName": "msdyn_costimpact",
      "DisplayName": "Cost Impact ($)",
      "Type": "Money",
      "Precision": 2
    }
  ]
}
```

#### 8. msdyn_samplingplan (Core Sampling Plans)

```json
{
  "SchemaName": "msdyn_samplingplan",
  "DisplayName": "Sampling Plan",
  "PluralDisplayName": "Sampling Plans",
  "Attributes": [
    {
      "SchemaName": "msdyn_samplingplanid",
      "Type": "PrimaryKey"
    },
    {
      "SchemaName": "msdyn_job",
      "DisplayName": "Related Job",
      "Type": "Lookup",
      "Target": "msdyn_job",
      "Required": true
    },
    {
      "SchemaName": "msdyn_lotno",
      "DisplayName": "Lot Number",
      "Type": "String",
      "MaxLength": 50,
      "Required": true
    },
    {
      "SchemaName": "msdyn_specification",
      "DisplayName": "Specification",
      "Type": "String",
      "MaxLength": 200
    },
    {
      "SchemaName": "msdyn_startchainage",
      "DisplayName": "Start Chainage (m)",
      "Type": "Decimal",
      "Precision": 10,
      "Scale": 2
    },
    {
      "SchemaName": "msdyn_endchainage",
      "DisplayName": "End Chainage (m)",
      "Type": "Decimal",
      "Precision": 10,
      "Scale": 2
    },
    {
      "SchemaName": "msdyn_numcores",
      "DisplayName": "Number of Cores",
      "Type": "Integer",
      "MinValue": 1
    },
    {
      "SchemaName": "msdyn_generatedby",
      "DisplayName": "Generated By",
      "Type": "Lookup",
      "Target": "systemuser",
      "Required": true
    },
    {
      "SchemaName": "msdyn_timestamp",
      "DisplayName": "Generated Timestamp",
      "Type": "DateTime",
      "Format": "DateAndTime",
      "Required": true
    },
    {
      "SchemaName": "msdyn_algorithmused",
      "DisplayName": "Algorithm Used",
      "Type": "String",
      "MaxLength": 100,
      "Description": "e.g., 'Stratified Random AS 2891.1.1'"
    }
  ],
  "Relationships": [
    {
      "SchemaName": "msdyn_samplingplan_results",
      "Type": "OneToMany",
      "ReferencedEntity": "msdyn_samplingresult"
    }
  ]
}
```

**msdyn_samplingresult (Individual Core Locations)**

```json
{
  "SchemaName": "msdyn_samplingresult",
  "DisplayName": "Sampling Result",
  "Attributes": [
    {
      "SchemaName": "msdyn_samplingresultid",
      "Type": "PrimaryKey"
    },
    {
      "SchemaName": "msdyn_samplingplan",
      "Type": "Lookup",
      "Target": "msdyn_samplingplan",
      "Required": true
    },
    {
      "SchemaName": "msdyn_corenumber",
      "DisplayName": "Core Number",
      "Type": "Integer"
    },
    {
      "SchemaName": "msdyn_chainage",
      "DisplayName": "Chainage (m)",
      "Type": "Decimal",
      "Precision": 10,
      "Scale": 2
    },
    {
      "SchemaName": "msdyn_offset",
      "DisplayName": "Offset",
      "Type": "OptionSet",
      "Options": [
        {"Value": 1, "Label": "LWP (Left Wheel Path)"},
        {"Value": 2, "Label": "RWP (Right Wheel Path)"},
        {"Value": 3, "Label": "Between WP (Between Wheel Paths)"}
      ]
    },
    {
      "SchemaName": "msdyn_notes",
      "DisplayName": "Notes",
      "Type": "String",
      "MaxLength": 500
    },
    {
      "SchemaName": "msdyn_actualdepth",
      "DisplayName": "Actual Depth (mm)",
      "Type": "Decimal",
      "Precision": 5,
      "Scale": 2
    },
    {
      "SchemaName": "msdyn_compliancestatus",
      "DisplayName": "Compliance Status",
      "Type": "OptionSet",
      "Options": [
        {"Value": 1, "Label": "Compliant", "Color": "#107C10"},
        {"Value": 2, "Label": "Non-Compliant", "Color": "#D13438"},
        {"Value": 3, "Label": "Pending Test", "Color": "#0078D4"}
      ]
    }
  ]
}
```

#### 9. Resource Tables

**msdyn_crewmember (Crew Members/Labour)**

```json
{
  "SchemaName": "msdyn_crewmember",
  "DisplayName": "Crew Member",
  "PluralDisplayName": "Crew Members",
  "Attributes": [
    {
      "SchemaName": "msdyn_crewmemberid",
      "Type": "PrimaryKey"
    },
    {
      "SchemaName": "msdyn_name",
      "DisplayName": "Name",
      "Type": "String",
      "MaxLength": 100,
      "Required": true
    },
    {
      "SchemaName": "msdyn_division",
      "DisplayName": "Division",
      "Type": "OptionSet",
      "Options": [
        {"Value": 1, "Label": "Asphalt"},
        {"Value": 2, "Label": "Profiling"},
        {"Value": 3, "Label": "Spray"},
        {"Value": 4, "Label": "Common"}
      ]
    },
    {
      "SchemaName": "msdyn_isforeman",
      "DisplayName": "Is Foreman",
      "Type": "Boolean",
      "DefaultValue": false
    },
    {
      "SchemaName": "msdyn_userid",
      "DisplayName": "System User",
      "Type": "Lookup",
      "Target": "systemuser",
      "Description": "Link to user account if they have login"
    },
    {
      "SchemaName": "msdyn_employeenumber",
      "DisplayName": "Employee Number",
      "Type": "String",
      "MaxLength": 50
    },
    {
      "SchemaName": "msdyn_phone",
      "DisplayName": "Phone",
      "Type": "String",
      "MaxLength": 50,
      "Format": "Phone"
    },
    {
      "SchemaName": "msdyn_email",
      "DisplayName": "Email",
      "Type": "String",
      "MaxLength": 100,
      "Format": "Email"
    },
    {
      "SchemaName": "msdyn_isactive",
      "DisplayName": "Is Active",
      "Type": "Boolean",
      "DefaultValue": true
    }
  ]
}
```

**msdyn_equipment (Plant & Equipment)**

```json
{
  "SchemaName": "msdyn_equipment",
  "DisplayName": "Equipment",
  "PluralDisplayName": "Equipment Register",
  "Attributes": [
    {
      "SchemaName": "msdyn_equipmentid",
      "Type": "PrimaryKey"
    },
    {
      "SchemaName": "msdyn_fleetid",
      "DisplayName": "Fleet ID",
      "Type": "String",
      "MaxLength": 50,
      "Required": true,
      "IsSearchable": true
    },
    {
      "SchemaName": "msdyn_name",
      "DisplayName": "Equipment Name",
      "Type": "String",
      "MaxLength": 200,
      "Required": true
    },
    {
      "SchemaName": "msdyn_type",
      "DisplayName": "Equipment Type",
      "Type": "String",
      "MaxLength": 100,
      "Description": "e.g., Profiler, Paver, Roller"
    },
    {
      "SchemaName": "msdyn_division",
      "DisplayName": "Division",
      "Type": "OptionSet",
      "Options": [
        {"Value": 1, "Label": "Asphalt"},
        {"Value": 2, "Label": "Profiling"},
        {"Value": 3, "Label": "Spray"},
        {"Value": 4, "Label": "Common"}
      ]
    },
    {
      "SchemaName": "msdyn_manufacturer",
      "DisplayName": "Manufacturer",
      "Type": "String",
      "MaxLength": 100
    },
    {
      "SchemaName": "msdyn_model",
      "DisplayName": "Model",
      "Type": "String",
      "MaxLength": 100
    },
    {
      "SchemaName": "msdyn_serialnumber",
      "DisplayName": "Serial Number",
      "Type": "String",
      "MaxLength": 100
    },
    {
      "SchemaName": "msdyn_isactive",
      "DisplayName": "Is Active",
      "Type": "Boolean",
      "DefaultValue": true
    },
    {
      "SchemaName": "msdyn_lastservicedate",
      "DisplayName": "Last Service Date",
      "Type": "DateTime",
      "Format": "DateOnly"
    },
    {
      "SchemaName": "msdyn_nextservicedue",
      "DisplayName": "Next Service Due",
      "Type": "DateTime",
      "Format": "DateOnly"
    }
  ]
}
```

#### 10. ITP Templates & Checklists

**msdyn_itptemplate (ITP Template Master)**

```json
{
  "SchemaName": "msdyn_itptemplate",
  "DisplayName": "ITP Template",
  "PluralDisplayName": "ITP Templates",
  "Attributes": [
    {
      "SchemaName": "msdyn_itptemplateid",
      "Type": "PrimaryKey"
    },
    {
      "SchemaName": "msdyn_name",
      "DisplayName": "Template Name",
      "Type": "String",
      "MaxLength": 200,
      "Required": true
    },
    {
      "SchemaName": "msdyn_documentid",
      "DisplayName": "Document ID",
      "Type": "String",
      "MaxLength": 100
    },
    {
      "SchemaName": "msdyn_division",
      "DisplayName": "Division",
      "Type": "OptionSet",
      "Options": [
        {"Value": 1, "Label": "Asphalt"},
        {"Value": 2, "Label": "Profiling"},
        {"Value": 3, "Label": "Spray"},
        {"Value": 4, "Label": "Common"}
      ]
    },
    {
      "SchemaName": "msdyn_sections",
      "DisplayName": "Sections JSON",
      "Type": "Memo",
      "MaxLength": 100000,
      "Description": "JSON structure containing sections and checklist items"
    },
    {
      "SchemaName": "msdyn_isactive",
      "DisplayName": "Is Active",
      "Type": "Boolean",
      "DefaultValue": true
    },
    {
      "SchemaName": "msdyn_version",
      "DisplayName": "Version",
      "Type": "String",
      "MaxLength": 20
    },
    {
      "SchemaName": "msdyn_createdby",
      "DisplayName": "Created By",
      "Type": "Lookup",
      "Target": "systemuser"
    }
  ]
}
```

**msdyn_itpchecklist (Completed ITP Checklist)**

```json
{
  "SchemaName": "msdyn_itpchecklist",
  "DisplayName": "ITP Checklist",
  "Attributes": [
    {
      "SchemaName": "msdyn_itpchecklistid",
      "Type": "PrimaryKey"
    },
    {
      "SchemaName": "msdyn_qapack",
      "DisplayName": "QA Pack",
      "Type": "Lookup",
      "Target": "msdyn_qapack",
      "Required": true
    },
    {
      "SchemaName": "msdyn_template",
      "DisplayName": "Template Used",
      "Type": "Lookup",
      "Target": "msdyn_itptemplate"
    },
    {
      "SchemaName": "msdyn_checklistdata",
      "DisplayName": "Checklist Data JSON",
      "Type": "Memo",
      "MaxLength": 100000,
      "Description": "Complete checklist with responses"
    },
    {
      "SchemaName": "msdyn_compliancepercentage",
      "DisplayName": "Compliance %",
      "Type": "Decimal",
      "Precision": 5,
      "Scale": 2,
      "CalculationFormula": "Percentage of items marked 'Yes'"
    },
    {
      "SchemaName": "msdyn_noncompliantitems",
      "DisplayName": "Non-Compliant Items Count",
      "Type": "Integer"
    }
  ]
}
```

#### 11. Document Management

**msdyn_document (Document Library References)**

```json
{
  "SchemaName": "msdyn_document",
  "DisplayName": "Document",
  "PluralDisplayName": "Document Library",
  "Attributes": [
    {
      "SchemaName": "msdyn_documentid",
      "Type": "PrimaryKey"
    },
    {
      "SchemaName": "msdyn_title",
      "DisplayName": "Document Title",
      "Type": "String",
      "MaxLength": 300,
      "Required": true,
      "IsSearchable": true
    },
    {
      "SchemaName": "msdyn_category",
      "DisplayName": "Category",
      "Type": "OptionSet",
      "Options": [
        {"Value": 1, "Label": "Specification"},
        {"Value": 2, "Label": "Procedure"},
        {"Value": 3, "Label": "Form Template"},
        {"Value": 4, "Label": "Training Material"},
        {"Value": 5, "Label": "Australian Standard"},
        {"Value": 6, "Label": "MRWA Specification"},
        {"Value": 7, "Label": "Other"}
      ],
      "Required": true
    },
    {
      "SchemaName": "msdyn_sharepointurl",
      "DisplayName": "SharePoint URL",
      "Type": "String",
      "MaxLength": 500,
      "Format": "Url"
    },
    {
      "SchemaName": "msdyn_filetype",
      "DisplayName": "File Type",
      "Type": "String",
      "MaxLength": 20
    },
    {
      "SchemaName": "msdyn_uploadedby",
      "DisplayName": "Uploaded By",
      "Type": "Lookup",
      "Target": "systemuser"
    },
    {
      "SchemaName": "msdyn_uploaddate",
      "DisplayName": "Upload Date",
      "Type": "DateTime",
      "Format": "DateAndTime"
    },
    {
      "SchemaName": "msdyn_version",
      "DisplayName": "Version",
      "Type": "String",
      "MaxLength": 20
    },
    {
      "SchemaName": "msdyn_ispublic",
      "DisplayName": "Is Public",
      "Type": "Boolean",
      "DefaultValue": false,
      "Description": "Visible to foremen or admin only"
    },
    {
      "SchemaName": "msdyn_tags",
      "DisplayName": "Tags",
      "Type": "String",
      "MaxLength": 500,
      "Description": "Comma-separated tags for search"
    }
  ]
}
```

**msdyn_sitephoto (Site Photos)**

```json
{
  "SchemaName": "msdyn_sitephoto",
  "DisplayName": "Site Photo",
  "Attributes": [
    {
      "SchemaName": "msdyn_sitephotoid",
      "Type": "PrimaryKey"
    },
    {
      "SchemaName": "msdyn_qapack",
      "DisplayName": "QA Pack",
      "Type": "Lookup",
      "Target": "msdyn_qapack",
      "Required": true
    },
    {
      "SchemaName": "msdyn_description",
      "DisplayName": "Description",
      "Type": "String",
      "MaxLength": 500
    },
    {
      "SchemaName": "msdyn_sharepointurl",
      "DisplayName": "SharePoint Photo URL",
      "Type": "String",
      "MaxLength": 500,
      "Format": "Url"
    },
    {
      "SchemaName": "msdyn_captureddate",
      "DisplayName": "Captured Date",
      "Type": "DateTime",
      "Format": "DateAndTime"
    },
    {
      "SchemaName": "msdyn_geolocation",
      "DisplayName": "GPS Location",
      "Type": "String",
      "MaxLength": 100,
      "Description": "Lat,Long coordinates"
    },
    {
      "SchemaName": "msdyn_sequencenumber",
      "DisplayName": "Sequence",
      "Type": "Integer"
    }
  ]
}
```

#### 12. Audit Log (Complete Change Tracking)

**msdyn_auditlog (Comprehensive Audit Trail)**

```json
{
  "SchemaName": "msdyn_auditlog",
  "DisplayName": "Audit Log Entry",
  "PluralDisplayName": "Audit Log",
  "Attributes": [
    {
      "SchemaName": "msdyn_auditlogid",
      "Type": "PrimaryKey"
    },
    {
      "SchemaName": "msdyn_entityname",
      "DisplayName": "Entity Name",
      "Type": "String",
      "MaxLength": 100,
      "Required": true
    },
    {
      "SchemaName": "msdyn_entityid",
      "DisplayName": "Entity ID",
      "Type": "String",
      "MaxLength": 100,
      "Required": true
    },
    {
      "SchemaName": "msdyn_action",
      "DisplayName": "Action",
      "Type": "OptionSet",
      "Options": [
        {"Value": 1, "Label": "CREATE"},
        {"Value": 2, "Label": "UPDATE"},
        {"Value": 3, "Label": "DELETE"},
        {"Value": 4, "Label": "APPROVE"},
        {"Value": 5, "Label": "REJECT"},
        {"Value": 6, "Label": "STATUS_CHANGE"}
      ],
      "Required": true
    },
    {
      "SchemaName": "msdyn_performedby",
      "DisplayName": "Performed By",
      "Type": "Lookup",
      "Target": "systemuser",
      "Required": true
    },
    {
      "SchemaName": "msdyn_timestamp",
      "DisplayName": "Timestamp",
      "Type": "DateTime",
      "Format": "DateAndTime",
      "Required": true,
      "Behavior": "UserLocal"
    },
    {
      "SchemaName": "msdyn_changes",
      "DisplayName": "Changes JSON",
      "Type": "Memo",
      "MaxLength": 50000,
      "Description": "JSON array of field changes: [{field, oldValue, newValue}]"
    },
    {
      "SchemaName": "msdyn_ipaddress",
      "DisplayName": "IP Address",
      "Type": "String",
      "MaxLength": 50
    },
    {
      "SchemaName": "msdyn_useragent",
      "DisplayName": "User Agent",
      "Type": "String",
      "MaxLength": 500
    },
    {
      "SchemaName": "msdyn_sessionid",
      "DisplayName": "Session ID",
      "Type": "String",
      "MaxLength": 100
    }
  ],
  "Indexes": [
    {
      "Name": "idx_entity_lookup",
      "Columns": ["msdyn_entityname", "msdyn_entityid"]
    },
    {
      "Name": "idx_timestamp",
      "Columns": ["msdyn_timestamp"]
    }
  ]
}
```

---

## Security Roles Definition

### Role: Foreman

```json
{
  "Name": "Foreman",
  "Description": "Field workers who submit QA packs",
  "Privileges": {
    "msdyn_job": {
      "Read": "User",
      "Write": "None",
      "Create": "None",
      "Delete": "None",
      "Append": "User",
      "AppendTo": "None"
    },
    "msdyn_qapack": {
      "Read": "User",
      "Write": "User",
      "Create": "Organization",
      "Delete": "None",
      "Append": "User",
      "AppendTo": "None"
    },
    "msdyn_dailyreport": {
      "Read": "User",
      "Write": "User",
      "Create": "User",
      "Delete": "None"
    },
    "msdyn_incident": {
      "Read": "User",
      "Write": "User",
      "Create": "Organization",
      "Delete": "None"
    },
    "msdyn_crewmember": {
      "Read": "Organization",
      "Write": "None",
      "Create": "None",
      "Delete": "None"
    },
    "msdyn_equipment": {
      "Read": "Organization",
      "Write": "None",
      "Create": "None",
      "Delete": "None"
    },
    "msdyn_document": {
      "Read": "Organization",
      "Write": "None",
      "Create": "None",
      "Delete": "None"
    }
  }
}
```

### Role: Engineer

```json
{
  "Name": "Engineer",
  "Description": "Reviews QA packs, manages jobs, raises NCRs",
  "Privileges": {
    "msdyn_job": {
      "Read": "Organization",
      "Write": "Organization",
      "Create": "Organization",
      "Delete": "Organization"
    },
    "msdyn_qapack": {
      "Read": "Organization",
      "Write": "Organization",
      "Create": "Organization",
      "Delete": "None"
    },
    "msdyn_ncr": {
      "Read": "Organization",
      "Write": "Organization",
      "Create": "Organization",
      "Delete": "None"
    },
    "msdyn_samplingplan": {
      "Read": "Organization",
      "Write": "Organization",
      "Create": "Organization",
      "Delete": "Organization"
    },
    "msdyn_incident": {
      "Read": "Organization",
      "Write": "Organization",
      "Create": "Organization",
      "Delete": "None"
    }
  }
}
```

### Role: HSEQ Manager

```json
{
  "Name": "HSEQ Manager",
  "Description": "Manages incidents, NCRs, compliance",
  "Privileges": {
    "msdyn_incident": {
      "Read": "Organization",
      "Write": "Organization",
      "Create": "Organization",
      "Delete": "Organization"
    },
    "msdyn_ncr": {
      "Read": "Organization",
      "Write": "Organization",
      "Create": "Organization",
      "Delete": "Organization"
    },
    "msdyn_qapack": {
      "Read": "Organization",
      "Write": "None",
      "Create": "None",
      "Delete": "None"
    }
  },
  "FieldSecurity": {
    "msdyn_incident": {
      "msdyn_investigationfindings": {
        "CanRead": true,
        "CanUpdate": true
      },
      "msdyn_correctiveactions": {
        "CanRead": true,
        "CanUpdate": true
      }
    }
  }
}
```

---

## Data Migration Script (Redis to Dataverse)

### PowerShell Migration Script

```powershell
# Migration script: Redis to Dataverse
# Run this on a machine with access to both Redis and Dataverse

# Install required modules
Install-Module -Name Microsoft.PowerApps.Administration.PowerShell -Force
Install-Module -Name Microsoft.Xrm.Data.PowerShell -Force

# Connect to Dataverse
$conn = Get-CrmConnection -InteractiveMode

# Connect to Redis (using StackExchange.Redis .NET library)
Add-Type -Path "path\to\StackExchange.Redis.dll"
$redis = [StackExchange.Redis.ConnectionMultiplexer]::Connect("your-redis-connection-string")
$db = $redis.GetDatabase()

# Function to migrate jobs
function Migrate-Jobs {
    Write-Host "Migrating Jobs..." -ForegroundColor Cyan
    
    # Get all job keys from Redis
    $jobKeys = $db.SetMembers("jobs:index")
    
    foreach ($jobKey in $jobKeys) {
        $jobId = $jobKey.ToString()
        $jobData = $db.HashGetAll("job:$jobId")
        
        # Convert Redis hash to object
        $job = @{}
        foreach ($field in $jobData) {
            $job[$field.Name.ToString()] = $field.Value.ToString()
        }
        
        # Create in Dataverse
        $newJob = @{
            "msdyn_jobnumber" = $job.jobNo
            "msdyn_client" = $job.client
            "msdyn_projectname" = $job.projectName
            "msdyn_location" = $job.location
            "msdyn_division" = Get-DivisionOptionValue $job.division
            "msdyn_jobdate" = [DateTime]::Parse($job.jobDate)
            "msdyn_duedate" = [DateTime]::Parse($job.dueDate)
            "msdyn_assignedforeman" = Get-UserReference $job.foremanId
        }
        
        New-CrmRecord -conn $conn -EntityLogicalName "msdyn_job" -Fields $newJob
        Write-Host "  Migrated job: $($job.jobNo)" -ForegroundColor Green
    }
}

# Function to migrate QA packs
function Migrate-QAPacks {
    Write-Host "Migrating QA Packs..." -ForegroundColor Cyan
    
    $jobNumbers = $db.SetMembers("reports:index")
    
    foreach ($jobNo in $jobNumbers) {
        $historyKey = "history:$jobNo"
        $reports = $db.ListRange($historyKey, 0, -1)
        
        foreach ($reportJson in $reports) {
            $report = ConvertFrom-Json $reportJson
            
            # Create main QA Pack record
            $qaPackFields = @{
                "msdyn_reportid" = $report.job.jobNo + " " + $report.timestamp
                "msdyn_job" = Get-JobReference $report.job.jobNo
                "msdyn_submittedby" = Get-UserReference $report.submittedBy
                "msdyn_timestamp" = [DateTime]::Parse($report.timestamp)
                "msdyn_version" = [int]$report.version
                "msdyn_status" = 1 # Pending Review
                "msdyn_foremansignature" = $report.foremanSignature
                "msdyn_foremanphotourl" = $report.foremanPhotoUrl
                "msdyn_pdfurl" = $report.pdfUrl
                "msdyn_expertsummary" = $report.expertSummary
            }
            
            $qaPackId = New-CrmRecord -conn $conn -EntityLogicalName "msdyn_qapack" -Fields $qaPackFields
            
            # Migrate Daily Report
            if ($report.sgaDailyReport) {
                Migrate-DailyReport -QAPackId $qaPackId -DailyReport $report.sgaDailyReport
            }
            
            # Migrate Asphalt Placement
            if ($report.asphaltPlacement) {
                Migrate-AsphaltPlacement -QAPackId $qaPackId -AsphaltPlacement $report.asphaltPlacement
            }
            
            # Migrate Site Photos
            if ($report.sitePhotoUrls) {
                Migrate-SitePhotos -QAPackId $qaPackId -PhotoUrls $report.sitePhotoUrls
            }
            
            Write-Host "  Migrated QA Pack: $($report.job.jobNo) v$($report.version)" -ForegroundColor Green
        }
    }
}

# Helper function to migrate daily report and its child records
function Migrate-DailyReport {
    param($QAPackId, $DailyReport)
    
    $dailyReportFields = @{
        "msdyn_qapack" = @{"msdyn_qapackid" = $QAPackId}
        "msdyn_date" = [DateTime]::Parse($DailyReport.date)
        "msdyn_completedby" = $DailyReport.completedBy
        "msdyn_starttime" = $DailyReport.startTime
        "msdyn_finishtime" = $DailyReport.finishTime
        "msdyn_correctorused" = ($DailyReport.correctorUsed -eq "Yes")
        "msdyn_siteinstructions" = $DailyReport.siteInstructions
        "msdyn_additionalcomments" = $DailyReport.additionalComments
    }
    
    $dailyReportId = New-CrmRecord -conn $conn -EntityLogicalName "msdyn_dailyreport" -Fields $dailyReportFields
    
    # Migrate labour entries
    foreach ($labour in $DailyReport.labour) {
        $labourFields = @{
            "msdyn_dailyreport" = @{"msdyn_dailyreportid" = $dailyReportId}
            "msdyn_fullname" = $labour.fullName
            "msdyn_starttime" = $labour.startTime
            "msdyn_endtime" = $labour.endTime
            "msdyn_hours" = $labour.hours
            "msdyn_comments" = $labour.comments
        }
        New-CrmRecord -conn $conn -EntityLogicalName "msdyn_dailyreportlabour" -Fields $labourFields | Out-Null
    }
    
    # Migrate works, plant, trucks, tests...
    # (Similar pattern for other child entities)
}

# Execute migration
Write-Host "Starting Migration from Redis to Dataverse" -ForegroundColor Yellow
Migrate-Jobs
Migrate-QAPacks
Write-Host "Migration Complete!" -ForegroundColor Green
```

---

## Calculated Fields & Business Rules

### Automatic Calculations

**1. Total Tonnes in Asphalt Placement (Rollup Field)**

```javascript
// Field: msdyn_asphaltplacement.msdyn_totaltonnes
// Type: Rollup
{
  "SourceEntity": "msdyn_asphaltplacementrow",
  "SourceField": "msdyn_tonnes",
  "AggregateFunction": "Sum",
  "Filter": "msdyn_asphaltplacement eq @EntityId"
}
```

**2. Temperature Compliance Percentage (Calculated Field)**

```javascript
// Field: msdyn_asphaltplacement.msdyn_temperaturecompliance
// Type: Calculated (Complex - requires workflow)
// Power Automate Flow to calculate:
// 1. Trigger: When asphalt placement row is created/updated
// 2. Get all rows for this placement
// 3. Count total rows
// 4. Count rows where msdyn_tempscompliant = true
// 5. Calculate percentage
// 6. Update parent msdyn_asphaltplacement record
```

**3. Days Since Submission (Calculated Field)**

```javascript
// Field: msdyn_qapack.msdyn_dayssincesubmission
// Type: Calculated
{
  "Formula": "DATEDIFF(msdyn_timestamp, NOW(), DAY)"
}
```

### Business Rules

**1. NCR Status Workflow**

```javascript
// Business Rule: NCR can only be closed if all fields are complete
{
  "Name": "NCR Close Validation",
  "Scope": "Entity",
  "Conditions": [
    {
      "Field": "msdyn_status",
      "Operator": "Equals",
      "Value": 4 // Closed
    }
  ],
  "Actions": {
    "ValidateFields": [
      "msdyn_rootcauseanalysis",
      "msdyn_preventativeaction",
      "msdyn_verificationmethod",
      "msdyn_verifiedby"
    ],
    "ErrorMessage": "All required fields must be completed before closing an NCR."
  }
}
```

**2. Job Date Validation**

```javascript
// Business Rule: Due date must be after job date
{
  "Name": "Validate Job Dates",
  "Scope": "Entity",
  "Conditions": [
    {
      "Field": "msdyn_duedate",
      "Operator": "LessThan",
      "CompareToField": "msdyn_jobdate"
    }
  ],
  "Actions": {
    "ShowError": true,
    "ErrorMessage": "Due date must be after job date."
  }
}
```

---

## Next Steps

1. **Review Schema**: Ensure all fields match your requirements
2. **Create Tables**: Use Power Platform admin center or PowerShell
3. **Configure Security**: Set up security roles
4. **Test Migration**: Migrate a small subset of data first
5. **Build Apps**: Start building Power Apps against this schema

---

This completes the comprehensive Dataverse schema definition for the SGA QA Pack system.
